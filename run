#!/bin/bash -e

database="test1"

psql -c "
-- http://stackoverflow.com/questions/5108876/kill-a-postgresql-session-connection
SELECT 
    pg_terminate_backend(pid) 
FROM 
    pg_stat_activity 
WHERE 
    -- don't kill my own connection!
    pid <> pg_backend_pid()
    -- don't kill the connections to other databases
    AND datname = '${database}';
" postgres postgres

hamsql doc -s setup.example.yaml > doc/doc.html
hamsql doc -s setup.example.yaml -f dot > doc/doc-graph.dot
hamsql install -s setup.example.yaml -c "postgres://postgres@/${database}" -p > install.sql
dot -Tpdf -o doc/doc-graph.pdf doc/doc-graph.dot
cp doc/doc.html ../carnivora-doc/index.html
cp doc/s.css ../carnivora-doc/

hamsql install -s setup.example.yaml -d -c "postgres://postgres@/${database}"

export PAGER=cat
psql -P null=/NULL/ --set ON_ERROR_STOP=1 -f "test/prepare.sql" ${database} postgres
psql -P null=/NULL/ --set ON_ERROR_STOP=1 -f "test/frontend.sql" ${database} carnivora_edentata
psql -P null=/NULL/ --set ON_ERROR_STOP=1 -f "test/backend.sql" ${database} carnivora_mailserver

