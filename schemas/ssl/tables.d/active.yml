name: active
description: |
 Active cert_active

primary_key:
 - demand_id
 - machine_name

templates:
 - system.reference_service_entity

columns:
 - name: demand_id
   type: uuid
   description: ""

 - name: machine_name
   type: dns.t_hostname
   description: Machine

 - name: used
   type: uuid
   null: true
   description: |
    Currently active certificate. Taken from scheduled
    if the scheduled certificate has been deployed.

 - name: scheduled
   type: uuid
   null: true
   description: |
    Certificate to be deployed on machine. Renew is always based
    in relation to the scheduled to simplify the logic.

 - name: renew
   type: uuid
   null: true
   description: |
    Available if renew is in preparation. Moved to ``scheduled``
    if certificate available and time for replacement has come.

checks:
 - name: used_only_with_scheduled
   description: |
    The scheduled is not removed to simply some logic.
   check: |
    scheduled IS NOT NULL
    OR used IS NULL

 - name: subsequent_neq_current
   description: Subsequent must not be the same as current
   check: |
    scheduled IS NULL
    OR renew IS NULL
    OR scheduled <> renew

unique:
 - name: machine
   columns:
    - service
    - service_entity_name
    - machine_name

foreign_keys:
 - name: machine_with_service
   ref_table: system.service_entity_machine
   columns:
    - service
    - service_entity_name
    - machine_name

 - name: used_cert
   ref_table: ssl.cert
   columns: 
    - used
    - machine_name
   ref_columns:
    - id
    - machine_name
    
 - name: scheduled_cert
   ref_table: ssl.cert
   columns: 
    - scheduled
    - machine_name
   ref_columns:
    - id
    - machine_name

 - name: renew_cert
   ref_table: ssl.cert
   columns: 
    - renew
    - machine_name
   ref_columns:
    - id
    - machine_name

