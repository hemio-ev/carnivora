name: cert
description: |
 SSL (X.509) certificate

primary_key:
 - id

columns:
 - name: id
   type: uuid
   description: UUID
   default: commons._uuid()
   
 - name: demand_id
   type: uuid
   description: UUID
   
 - name: machine_name
   type: dns.t_domain
   description: Machine
   
 - name: domains
   type: varchar[]
   description: Domains
   checks:
     - name: min_one_domain
       description: Check
       check: array_length(domains, 1) > 0

 - name: request
   type: ssl.t_request
   description: Certificate request
   null: true

 - name: cert
   type: ssl.t_cert
   null: true
   description: Certificate

 - name: intermediate
   type: varchar
   null: true
   description: Intermediate
   references: ssl.intermediate.subject_key_identifier

checks:
 - name: request_domains
   description: Requests domains correct
   check: |
    request IS NULL OR
    (ssl.request_info(request))."subjectAltName" = domains
 - name: cert_domains
   description: Certificate domains correct
   check: |
    cert IS NULL OR
    (ssl.cert_info(cert))."subjectAltName" = domains
 - name: cert_only_with_request
   description: Cert only if request exists
   check: |
    cert IS NULL OR
    request IS NOT NULL
 - name: request_cert_match_pubkey
   description: Cert belongs to the request
   check: |
    (cert IS NULL OR request is NULL) OR
    (ssl.cert_info(cert)).public_key_bytes = 
    (ssl.request_info(request)).public_key_bytes

foreign_keys:
 - name: active_fk
   ref_table: ssl.active
   columns:
    - demand_id
    - machine_name

unique:
 - name: id_machine_name
   columns:
    - id
    - machine_name
