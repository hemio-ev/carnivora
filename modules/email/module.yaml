name: email
description: "E-Mail and Mailing lists âœ‰"
dependencies: [ domains ]
priv_all_all:
 - system
priv_usage:
 - userlogin
 - backend

exec_post_install: |
 SELECT system._setup_register_service_entity('email', 'email');
 SELECT system._setup_register_service_entity('email', 'email__list');
 SELECT system._setup_register_service_entity('email', 'web');
 SELECT setval('email.mailbox_uid_seq', 100000);

function_templates:
 -
  template: insert
  description: does the contingent checks
  body_prelude: |
    v_num_total := (SELECT COUNT(*) FROM email._address() AS t WHERE t.owner=v_owner);
    v_num_domain := (SELECT COUNT(*) FROM email._address() AS t WHERE t.owner=v_owner AND t.domain = p_domain);

    PERFORM system._contingent_ensure(
        p_owner:=v_owner,
        p_domain:=p_domain,
        p_service:='email',
        p_current_quantity_total:=v_num_total,
        p_current_quantity_domain:=v_num_domain);

column_templates:
 -
  template: name
  name: name
  type: dns.t_domain
  description: Name like sub.example.org. This defines to which name the resource record pertains.
 -
  template: type
  name: type
  type: dns.t_type
  description: Type (?) like MX, A, AAAA, ...

table_templates:
 -
  template: address
  description: Address

  columns:
   -
    name: service
    type: system.t_service
    description: Enforce service type in dns.service
    checks:
     -
      name: service type
      description: ensures that service type is email
      check: service = 'email'
    default: "'email'"
   -
    name: localpart
    type: email.t_localpart
    description: Local part of the address

domains:
 -
  name: t_localpart
  description: Local part of an email address, the thing in front of the @
  type: varchar(64)

  checks:
   -
    name: valid_characters
    description: Only allow lower-case addresses
    check: VALUE ~ '^[a-z0-9.-]+$'
   -
    name: no_starting_dot
    description: b
    check: left(VALUE, 1) <> '.'
   -
    name: no_ending_dot
    description: c
    check: right(VALUE, 1) <> '.'

 -
  name: t_address
  description: Email address, TODO validity checks
  type: varchar(253)
